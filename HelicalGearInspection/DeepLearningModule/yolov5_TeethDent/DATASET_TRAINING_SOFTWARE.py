# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'pkka_final2.ui'
#
# Created by: PyQt5 UI code generator 5.15.4
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.


from PyQt5 import QtCore, QtGui, QtWidgets
from PyQt5.QtWidgets import QFileDialog, QMessageBox
from PyQt5.QtWidgets import QApplication, QMessageBox
from PyQt5 import QtCore, QtGui, QtWidgets
import cv2
import numpy as np
import random
import tempfile
import os
import subprocess
import shutil
import configparser

CONFIG_FILE = 'config.ini'

def run_python_script(script_directory, script_name):
    script_path = f'{script_directory}\\{script_name}'

    try:
        subprocess.run(['python', script_path], check=True)
    except subprocess.CalledProcessError as e:
        print(f"Error running {script_name}: {e}")
    except FileNotFoundError:
        print(f"Script {script_name} not found in directory {script_directory}")

class Ui_MainWindow(object):
    def setupUi(self, MainWindow):
        MainWindow.setObjectName("MainWindow")
        MainWindow.resize(1898, 913)
        MainWindow.setStyleSheet("Background-color:rgb(211, 247, 255);")
        self.centralwidget = QtWidgets.QWidget(MainWindow)
        self.centralwidget.setObjectName("centralwidget")
        self.label_2 = QtWidgets.QLabel(self.centralwidget)
        self.label_2.setGeometry(QtCore.QRect(0, -20, 1891, 191))
        font = QtGui.QFont()
        font.setFamily("MS Shell Dlg 2")
        font.setPointSize(36)
        font.setBold(False)
        font.setItalic(False)
        font.setWeight(9)
        self.label_2.setFont(font)
        self.label_2.setStyleSheet("Background-color:rgb(90, 164, 255);\n"
"font: 75 36pt \"MS Shell Dlg 2\";\n"
"\n"
"")
        self.label_2.setObjectName("label_2")
        self.pushButton = QtWidgets.QPushButton(self.centralwidget)
        self.pushButton.setEnabled(True)
        self.pushButton.setGeometry(QtCore.QRect(650, 230, 591, 231))
        self.pushButton.setStyleSheet("Background-color:rgb(162, 182, 255);\n"
"font: 87 20pt \"Segoe UI Black\";")
        self.pushButton.setObjectName("pushButton")
        self.pushButton.clicked.connect(self.run_script)
        self.pushButton_2 = QtWidgets.QPushButton(self.centralwidget)
        self.pushButton_2.setEnabled(True)
        self.pushButton_2.setGeometry(QtCore.QRect(1280, 230, 591, 231))
        self.pushButton_2.setStyleSheet("font: 87 20pt \"Segoe UI Black\";\n"
"Background-color:rgb(162, 182, 255);")
        self.pushButton_2.setObjectName("pushButton_2")
        self.pushButton_2.clicked.connect(self.seprate_images)
        self.pushButton_3 = QtWidgets.QPushButton(self.centralwidget)
        self.pushButton_3.setEnabled(True)
        self.pushButton_3.setGeometry(QtCore.QRect(660, 520, 591, 231))
        self.pushButton_3.setStyleSheet("font: 87 20pt \"Segoe UI Black\";\n"
"Background-color:rgb(162, 182, 255);")
        self.pushButton_3.setObjectName("pushButton_3")
        self.pushButton_3.clicked.connect(self.run_yolov5_training)
        self.label_3 = QtWidgets.QLabel(self.centralwidget)
        self.label_3.setGeometry(QtCore.QRect(1770, 800, 111, 71))
        self.label_3.setStyleSheet("Background-image:url(:/newPrefix/Downloads/Screenshot (66).png)")
        self.label_3.setFrameShape(QtWidgets.QFrame.Box)
        self.label_3.setText("")
        self.label_3.setPixmap(QtGui.QPixmap(":/newPrefix/Downloads/Screenshot (66).png"))
        self.label_3.setScaledContents(True)
        self.label_3.setObjectName("label_3")
        self.label_4 = QtWidgets.QLabel(self.centralwidget)
        self.label_4.setGeometry(QtCore.QRect(1440, 800, 321, 81))
        font = QtGui.QFont()
        font.setFamily("Tahoma")
        font.setPointSize(20)
        font.setBold(False)
        font.setItalic(False)
        font.setWeight(9)
        self.label_4.setFont(font)
        self.label_4.setStyleSheet("font: 75 16pt \"Calibri\";\n"
"\n"
"font: 75 20pt \"Tahoma\";")
        self.label_4.setObjectName("label_4")
        self.pushButton_4 = QtWidgets.QPushButton(self.centralwidget)
        self.pushButton_4.setGeometry(QtCore.QRect(30, 230, 581, 241))
        self.pushButton_4.setStyleSheet("font: 87 20pt \"Segoe UI Black\";\n"
"Background-color:rgb(162, 182, 255);")
        self.pushButton_4.setObjectName("pushButton_4")
        self.pushButton_4.clicked.connect(self.process_image)
        self.pushButton_5 = QtWidgets.QPushButton(self.centralwidget)
        self.pushButton_5.setGeometry(QtCore.QRect(1290, 510, 591, 231))
        self.pushButton_5.setStyleSheet("Background-color:rgb(162, 182, 255);\n"
"font: 87 20pt \"Segoe UI Black\";")
        self.pushButton_5.setObjectName("pushButton_5")
        self.pushButton_5.clicked.connect(self.send_weights_to_fixed_folder)
        self.pushButton_6 = QtWidgets.QPushButton(self.centralwidget)
        self.pushButton_6.setGeometry(QtCore.QRect(30, 520, 591, 231))
        self.pushButton_6.setStyleSheet("Background-color:rgb(162, 182, 255);\n"
"font: 87 20pt \"Segoe UI Black\";")
        self.pushButton_6.setObjectName("pushButton_6")
        self.pushButton_6.clicked.connect(self.copy_files)
        MainWindow.setCentralWidget(self.centralwidget)
        self.menubar = QtWidgets.QMenuBar(MainWindow)
        self.menubar.setGeometry(QtCore.QRect(0, 0, 1898, 21))
        self.menubar.setObjectName("menubar")
        MainWindow.setMenuBar(self.menubar)
        self.statusbar = QtWidgets.QStatusBar(MainWindow)
        self.statusbar.setObjectName("statusbar")
        MainWindow.setStatusBar(self.statusbar)

        self.retranslateUi(MainWindow)
        QtCore.QMetaObject.connectSlotsByName(MainWindow)

    def retranslateUi(self, MainWindow):
        _translate = QtCore.QCoreApplication.translate
        MainWindow.setWindowTitle(_translate("MainWindow", "MainWindow"))
        self.label_2.setText(_translate("MainWindow", "<html><head/><body><p align=\"center\"><span style=\" font-size:48pt;\">DATASET TRAINING SOFTWARE</span></p></body></html>"))
        self.pushButton.setText(_translate("MainWindow", "OPEN ANNOTATION TOOLS"))
        self.pushButton_2.setText(_translate("MainWindow", "SEPRATE IMAGES & TEXT FILES"))
        self.pushButton_3.setText(_translate("MainWindow", "START TRANING"))
        self.label_4.setText(_translate("MainWindow", "<html><head/><body><p align=\"center\"><span style=\" font-weight:600;\">Add innovations Pvt Ltd</span></p></body></html>"))
        self.pushButton_4.setText(_translate("MainWindow", " UPLOAD IMAGES"))
        self.pushButton_5.setText(_translate("MainWindow", "TRANSFER WEIGHT"))
        self.pushButton_6.setText(_translate("MainWindow", "SHIFT .YAML FILE"))

    def run_script(self):
        script_directory = r'D:\New folder\HelicalGearInspection\HelicalGearInspection\DeepLearningModule\yolov5_TeethDent\Annotation_Tool'
        script_name = 'labelImg.py'
        run_python_script(script_directory, script_name)   

    def copy_to_multiple_paths(self, source_path, destination_path1, destination_path2):
        try:
            if os.path.exists(source_path):
                shutil.copy(source_path, destination_path1)
                shutil.copy(source_path, destination_path2)
                print(f"File copied from {source_path} to {destination_path1} and {destination_path2} successfully.")
            else:
                print("Source file does not exist.")
        except FileNotFoundError:
            print("File not found.")
        except Exception as e:
            print(f"An error occurred: {e}")

    def copy_files(self):
        source_file_path = 'D:/New folder/HelicalGearInspection/HelicalGearInspection/DeepLearningModule/yolov5_TeethDent/datasets/dataset.yaml'  # Replace with the actual source file path
        destination_path_1 = 'D:/New folder/HelicalGearInspection/HelicalGearInspection/DeepLearningModule/yolov5_TeethDent/yolov5/data'  # Replace with the first destination folder path
        destination_path_2 = 'D:/New folder/HelicalGearInspection/HelicalGearInspection/DeepLearningModule/yolov5_TeethDent/yolov5'  # Replace with the second destination folder path

        file_name = os.path.basename(source_file_path)
        destination_file_path1 = os.path.join(destination_path_1, file_name)
        destination_file_path2 = os.path.join(destination_path_2, file_name)

        self.copy_to_multiple_paths(source_file_path, destination_file_path1, destination_file_path2)

    def seprate_images(self):
        # Your code for moving images here

        # Display a message box indicating that the separation has completed
        app = QApplication(sys.argv)
        message_box = QMessageBox()
        message_box.setWindowTitle("Task Complete")
        message_box.setText("Separation has completed.")
        message_box.exec_()

        print("Separation completed.")

        # Add the provided code here
        # Define the source directory (the "anmol" directory)
        source_directory = "D:\\New folder\\HelicalGearInspection\\HelicalGearInspection\\DeepLearningModule\\yolov5_TeethDent\\datasets"

        # Define the destination directories
        images_directory = os.path.join(source_directory, "images")
        label_directory = os.path.join(source_directory, "label")
        train_images_directory = os.path.join(images_directory, "train")
        val_images_directory = os.path.join(images_directory, "val")
        train_label_directory = os.path.join(label_directory, "train")
        val_label_directory = os.path.join(label_directory, "val")

        # Create destination directories if they don't exist
        os.makedirs(images_directory, exist_ok=True)
        os.makedirs(label_directory, exist_ok=True)
        os.makedirs(train_images_directory, exist_ok=True)
        os.makedirs(val_images_directory, exist_ok=True)
        os.makedirs(train_label_directory, exist_ok=True)
        os.makedirs(val_label_directory, exist_ok=True)

        # Create a temporary directory to avoid conflicts
        temp_dir = tempfile.mkdtemp()

        # Loop through all files in the source directory
        for filename in os.listdir(source_directory):
            source_file_path = os.path.join(source_directory, filename)

            # Check if the file is a text file
            if filename.endswith(".txt"):
                # Copy text files to the temporary directory
                shutil.copy(source_file_path, os.path.join(temp_dir, filename))
            else:
                # Check if the file is a directory (subdirectory)
                if os.path.isdir(source_file_path):
                    continue  # Skip directories

                # Copy image files to the temporary directory
                shutil.copy(source_file_path, os.path.join(temp_dir, filename))

        # List all the image files in the temporary directory
        image_files = [filename for filename in os.listdir(temp_dir) if not filename.endswith(".txt")]

        # Calculate the number of files for the train and val split
        total_files = len(image_files)
        num_train_files = int(0.9 * total_files)
        num_val_files = total_files - num_train_files

        # Randomly shuffle the list of image files
        random.shuffle(image_files)

        # Split the image files into train and val
        train_files = image_files[:num_train_files]
        val_files = image_files[num_train_files:]

        # Copy image files from the temporary directory to the appropriate destination folders (train and val)
        for filename in train_files:
            source_file_path = os.path.join(temp_dir, filename)
            shutil.copy(source_file_path, os.path.join(train_images_directory, filename))

        for filename in val_files:
            source_file_path = os.path.join(temp_dir, filename)
            shutil.copy(source_file_path, os.path.join(val_images_directory, filename))

        # Copy text files from the temporary directory to the appropriate destination folders (train and val)
        txt_files = [filename for filename in os.listdir(temp_dir) if filename.endswith(".txt")]
        train_txt_files = txt_files[:num_train_files]
        val_txt_files = txt_files[num_train_files:]

        for filename in train_txt_files:
            source_file_path = os.path.join(temp_dir, filename)
            shutil.copy(source_file_path, os.path.join(train_label_directory, filename))

        for filename in val_txt_files:
            source_file_path = os.path.join(temp_dir, filename)
            shutil.copy(source_file_path, os.path.join(val_label_directory, filename))

        # Remove the temporary directory
        shutil.rmtree(temp_dir)

        # Remove all images and text files from the source_directory
        for filename in os.listdir(source_directory):
            file_path = os.path.join(source_directory, filename)
            if os.path.isfile(file_path):
                os.remove(file_path)

        # Display a message box indicating that the separation has completed
        app = QApplication(sys.argv)
        message_box = QMessageBox()
        message_box.setWindowTitle("Task Complete")
        message_box.setText("Separation has completed.")
        message_box.exec_()

        print("Separation completed.")
    
    def process_image(self):
        input_folder = str(QFileDialog.getExistingDirectory(None, "Select Directory"))
        output_folder = r'D:\\New folder\\HelicalGearInspection\\HelicalGearInspection\\DeepLearningModule\\yolov5_TeethDent\\datasets'

        if not os.path.exists(output_folder):
            os.makedirs(output_folder)

        input_files = os.listdir(input_folder)

        for file_name in input_files:
            input_path = os.path.join(input_folder, file_name)

            # Read the image
            img = cv2.imread(input_path)

            if img is not None:
                # Perform perspective transformation
                img = cv2.rotate(img, cv2.ROTATE_90_CLOCKWISE)
                pts1 = np.float32([[0, 440], [1180, 0], [0, 1750], [1200, 1300]]) #cam1
                #pts1 = np.float32([[0, 595], [1180, 175], [0, 1845], [1200, 1505]])#cam2
                pts2 = np.float32([[0, 0], [950, 0], [0, 610], [950,610]])
                M = cv2.getPerspectiveTransform(pts1, pts2)
                dst = cv2.warpPerspective(img, M, (950,610))
                dst = dst[:,100:850]
                dst = cv2.cvtColor(dst, cv2.COLOR_BGR2RGB)
                return dst

                # Construct the full path of the output image
                output_path = os.path.join(output_folder, file_name)

                # Save the transformed image to the output folder
                cv2.imwrite(output_path, dst)
                print(f"Saved: {output_path}")
            else:
                print(f"Failed to read image: {input_path}")
    
    def get_last_used_directory(self):
        config = configparser.ConfigParser()
        if os.path.exists(CONFIG_FILE):
            config.read(CONFIG_FILE)
            if 'General' in config and 'last_used_directory' in config['General']:
                return config['General']['last_used_directory']
        return os.path.expanduser("~")

    def set_last_used_directory(self, directory):
        config = configparser.ConfigParser()
        config['General'] = {'last_used_directory': directory}
        with open(CONFIG_FILE, 'w') as configfile:
            config.write(configfile)

    def send_weights_to_fixed_folder(self):
        try:
            destination_path = "D:\\New folder\\HelicalGearInspection\\HelicalGearInspection\\DeepLearningModule\\yolov5_TeethDent\\yolov5"  # Replace this with your fixed destination path

            if not os.path.exists(destination_path):
                os.makedirs(destination_path)

            app = QApplication([])  # Creating a QApp instance for the file dialog
            last_used_directory = self.get_last_used_directory()
            file_dialog = QFileDialog()
            file_dialog.setFileMode(QFileDialog.ExistingFiles)
            file_dialog.setDirectory(last_used_directory)
            if file_dialog.exec_():
                source_files = file_dialog.selectedFiles()
                for file_path in source_files:
                    file_name = os.path.basename(file_path)
                    shutil.copy(file_path, os.path.join(destination_path, file_name))
                    print(f"File {file_name} copied to {destination_path} successfully.")
                self.set_last_used_directory(file_dialog.directory().absolutePath())

        except Exception as e:
            print(f"An error occurred: {e}")
        
    def run_yolov5_training(self):
        environment_name = "pytorch"
        directory_path = r"D:\\New folder\\HelicalGearInspection\\HelicalGearInspection\\DeepLearningModule\\yolov5_TeethDent\\yolov5"
        yolov5_training_command = "python train.py --img 640 --batch 16 --epochs 100 --data dataset.yaml --weights yolov5s.pt --cache"
        try:
            # Activate the Anaconda environment
            activate_cmd = f'conda activate {environment_name}'

            # Create a subprocess to open Anaconda prompt, activate the environment, change directory, and execute the YOLOv5 training command
            command = f'start cmd.exe /K "{activate_cmd} && cd /d {directory_path} && {yolov5_training_command}"'
            subprocess.Popen(command, shell=True)
        except Exception as e:
            print(f"An error occurred: {e}")

  


if __name__ == "__main__":
    import sys
    app = QtWidgets.QApplication(sys.argv)
    MainWindow = QtWidgets.QMainWindow()
    ui = Ui_MainWindow()
    ui.setupUi(MainWindow)
    MainWindow.show()
    sys.exit(app.exec_())
